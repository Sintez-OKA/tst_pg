# Тестовое задание — PostgreSQL (разработка + администрирование)

## Цель
Оценить практические навыки кандидата по следующим направлениям:

- проектирование и нормализация БД
- написание эффективных SQL-запросов
- использование оконных функций, агрегатов, JOIN
- разработка хранимых процедур, функций, триггеров
- оптимизация запросов и работа с `EXPLAIN`
- настройка и администрирование PostgreSQL
- управление пользователями, резервное копирование, репликация

---

## Технологии
- **PostgreSQL 12+**
- SQL, PL/pgSQL
- Администрирование: roles, backups, tuning, monitoring

---

## Входные данные

### Таблица `orders` (производственные заказы)

| id | order_code | product   | quantity | due_date   | priority |
|---:|------------|-----------|---------:|------------|---------:|
| 1  | ORD-001    | Product-A | 120      | 2025-01-28 | 1        |
| 2  | ORD-002    | Product-C | 90       | 2025-02-10 | 2        |
| 3  | ORD-003    | Product-B | 50       | 2025-01-30 | 3        |
| 4  | ORD-004    | Product-A | 200      | 2025-02-01 | 1        |
| 5  | ORD-005    | Product-C | 70       | 2025-03-05 | 2        |

### Таблица `shipments` (фактические отгрузки)

| id | order_id | shipped_qty | shipped_at |
|---:|---------:|------------:|------------|
| 1  | 1        | 100         | 2025-01-25 |
| 2  | 1        | 20          | 2025-01-27 |
| 3  | 2        | 30          | 2025-02-01 |
| 4  | 4        | 50          | 2025-02-03 |

---

## Задания

### 1. **Проектирование БД**
1.1. Написать SQL (DDL) для создания таблиц `orders` и `shipments` с:
- Primary / Foreign keys
- `NOT NULL`, `CHECK`, корректные типы данных
- Индексы для поиска по `due_date`, `priority`, `product`

1.2. Добавить в `orders` поле `status`, которое должно отражать состояние исполнения:
- `pending` — нет отгрузок
- `partial` — отгружено < quantity
- `completed` — полностью отгружено

---

### 2. **SQL-аналитика**
Написать запросы:

2.1. Список заказов с процентом выполнения  
2.2. ТОП-3 продукта по суммарному количеству заказов  
2.3. Просроченные заказы (не выполнены и `due_date < today`)  
2.4. Кумулятивный объём отгрузок по датам (оконная функция)

---

### 3. **Функции и триггеры (PL/pgSQL)**

3.1. Функция `fn_order_fill_rate(p_order_id)` → возвращает % выполнения заказа  
3.2. Триггер на `shipments`, который обновляет `orders.status`  
3.3. Процедура `sp_bulk_load_orders(json)` для массовой загрузки заказов

---

### 4. **Оптимизация**

Кандидату будет предоставлен “медленный запрос” — нужно:

4.1. Проанализировать `EXPLAIN ANALYZE`  
4.2. Предложить оптимизацию (индексы / рефакторинг запроса)  
4.3. Показать сравнение **до/после**

---

### 5. **Администрирование PostgreSQL**

5.1. Создать пользователей и права:
- `frepple_app` → доступ на запись в схему `app`
- `report_user` → только SELECT

5.2. Настроить бэкапы:
- ежедневный `pg_dump`
- хранение 7 дней
- пример restore-проверки

5.3. Объяснить назначение параметров:
- `shared_buffers`
- `work_mem`
- `maintenance_work_mem`
- `effective_cache_size`

5.4. Описать:
- механизмы репликации (WAL, физическая и логическая, replication slots)
- настройку `pg_hba.conf` (безопасный доступ)

---

## Результат сдачи

Кандидат должен предоставить:

✅ SQL-скрипты  
✅ Краткий отчёт с пояснениями принятых решений  
✅ (Будет плюсом) `docker-compose.yml` с PostgreSQL  
✅ (Будет плюсом) пример автоматизации бэкапов

---

## Критерии оценки

| Критерий | Баллы (0–2) |
|---|---:|
| Корректность схемы БД | ☐ 0 ☐ 1 ☐ 2 |
| Индексы и оптимизация | ☐ 0 ☐ 1 ☐ 2 |
| Аналитические SQL | ☐ 0 ☐ 1 ☐ 2 |
| PL/pgSQL (функции, триггеры) | ☐ 0 ☐ 1 ☐ 2 |
| Понимание `EXPLAIN` | ☐ 0 ☐ 1 ☐ 2 |
| Роли и безопасность | ☐ 0 ☐ 1 ☐ 2 |
| Бэкапы и восстановление | ☐ 0 ☐ 1 ☐ 2 |
| Конфигурация сервера | ☐ 0 ☐ 1 ☐ 2 |
| Репликация | ☐ 0 ☐ 1 ☐ 2 |
| Качество оформления | ☐ 0 ☐ 1 ☐ 2 |

**Максимум: 20 баллов**

| Баллы | Уровень кандидата |
|---:|---|
| 18–20 | Отлично |
| 14–17 | Хороший уровень |
| 10–13 | Базовый, есть пробелы |
| < 10 | Нужен серьёзный рост |

---


---

Удачи и до встречи на техническом интервью!

