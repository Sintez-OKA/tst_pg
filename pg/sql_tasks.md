# SQL TASKS — Проверка навыков работы с PostgreSQL

## Цель
Оценить практические навыки написания сложных SQL-запросов, построения отчётных выборок, использования аналитических функций, подзапросов, CTE, JOIN, VIEW и оптимизации запросов.

Используйте таблицы `orders` и `shipments`, описанные в `README.md`.

---

## 1. JOIN (INNER, LEFT, RIGHT, FULL)

1.1. Вывести список всех заказов и фактически отгруженное количество, включая заказы без отгрузок.  
1.2. Показать все отгрузки, включая отгрузки, для которых заказ отсутствует.  
1.3. Показать объединённый результат заказов и отгрузок одной таблицей (даже если связи нет с обеих сторон).

---

## 2. Подзапросы

2.1. Для каждого заказа в `SELECT` вывести суммарный объём отгрузки (подзапросом).  
2.2. Найти заказы, у которых суммарный объём отгрузок **меньше среднего** по всем заказам.  
2.3. (Коррелированный подзапрос) Найти заказы, у которых объём отгрузок меньше, чем **средний объём отгрузки по тому же продукту**.

---

## 3. Агрегации + HAVING

3.1. Определить продукты, у которых суммарный объём заказов > 150.  
3.2. Вывести заказы, у которых количество отгрузок > 2.

---

## 4. Оконные функции (Window Functions)

4.1. Построить накопительный итог по отгрузкам в хронологическом порядке.  
4.2. Пронумеровать заказы по приближению срока исполнения (`due_date`).  
4.3. Вывести разницу в днях между текущей и предыдущей отгрузкой (`LAG`).

---

## 5. Общие табличные выражения (CTE / WITH)

5.1. С помощью CTE рассчитать `% исполнения` для каждого заказа и вывести только те, которые исполнены < 100%.  
5.2. Используя **2 последовательных CTE**, выполнить:
   - расчёт суммы отгрузок по заказу
   - определение статуса заказа (`pending/partial/completed`)

---

## 6. UNION / UNION ALL

6.1. Сформировать единый журнал событий:

| event_type | object_id | object_code | event_date |
|--------|-----------|--------------|------------|
| ORDER  | 5         | ORD-005      | 2025-03-05 |
| SHIPMENT | 3       | ORD-002      | 2025-02-01 |

---

## 7. Представления (VIEW)

7.1. Создать представление `vw_order_status`:

| order_code | product | qty_ordered | qty_shipped | fill_rate | status |
|------------|---------|-------------|-------------|-----------|--------|

где status:
- `pending` → отгрузок нет
- `partial` → частично отгружен
- `completed` → полностью отгружен

7.2. Написать запрос к `vw_order_status` для выбора **критичных заказов (`priority = 1`)**, которые не выполнены полностью.

---

## 8. Сложный аналитический отчет (одним SQL-запросом)

Сформировать отчет:

| product | orders_count | total_qty | completed_orders | avg_fill_rate % | last_shipment |
|---------|--------------|-----------|------------------|----------------|--------------|

Где:
- `orders_count` — число заказов на продукт
- `total_qty` — сумма заказанных qty
- `completed_orders` — полностью отгруженные
- `avg_fill_rate` — средний процент исполнения
- `last_shipment` — последняя дата отгрузки по продукту

---

## 9. Оптимизация и анализ

9.1. Проанализировать план выполнения запроса (предоставляется интервьюером).  
9.2. Предложить оптимизацию (индекс / рефакторинг SQL)  
9.3. Предоставить `EXPLAIN ANALYZE до/после`

---

## 10. Контрольные вопросы (письменно или устно)

1. Когда `LEFT JOIN` увеличивает количество строк?
2. Чем отличается `WHERE` от `HAVING`?
3. Когда подзапрос эффективнее `JOIN`, и наоборот?
4. В каких случаях PostgreSQL игнорирует индекс?
5. Что делает `VACUUM`, `ANALYZE`, `AUTOVACUUM`?
6. Зачем нужен `MATERIALIZED VIEW`?
7. Как ускорить `ORDER BY` на больших таблицах?
8. Объяснить разницу `UNION` и `UNION ALL`

---

## Требования к оформлению результата

Кандидат должен представить:

✅ SQL-скрипт с решением задач  
✅ Комментарии к сложным частям кода  
✅ Краткий текстовый отчёт, описывающий:
- Логику решения
- Выбор оптимизаций
- Возможные ограничения подхода

---

## Будет плюсом

- Использование `EXPLAIN ANALYZE` + вывод до/после оптимизации
- Создание индексов с обоснованием
- Использование `LATERAL JOIN`
- Примеры альтернативных подходов
- Аккуратное форматирование SQL (читаемость и стиль)

---

**Удачи! Мы оцениваем не только результат, но и подход.**
